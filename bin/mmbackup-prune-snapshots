#!/usr/bin/env python

import argparse
import datetime
import re
import subprocess
import sys

from mmsystems.backup.prune import label_snapshots


parser = argparse.ArgumentParser()
parser.add_argument('-n', '--dry-run', action='store_true')
parser.add_argument('-v', '--verbose', action='store_true')
parser.add_argument('-y', '--yes', action='store_true')
args = parser.parse_args()


raw = subprocess.check_output(['sudo', 'zfs', 'list', '-tsnapshot'])
raw = raw.splitlines()
raw.pop(0)
snapshots = [x.split()[0] for x in raw]

by_volume = {}
for snapshot in snapshots:
    volume, raw_ctime = snapshot.split('@', 1)
    by_volume.setdefault(volume, []).append((snapshot, raw_ctime))

for volume, snapshots in sorted(by_volume.iteritems()):

    if args.verbose:
        print volume
        print '=' * 20

    labels = label_snapshots(snapshots)

    for snapshot, raw_ctime in sorted(snapshots):
        label = labels.get(snapshot)
        if args.verbose:
            print '%7s %s' % (label or '-', snapshot)
        if not label:
            cmd = ['sudo', 'zfs', 'destroy', snapshot]
            if args.verbose:
                print '            $', ' '.join(cmd)
            if not args.dry_run:
                yes = args.yes
                if not yes:
                    res = raw_input('Delete %s ? [yN]: ' % snapshot).strip()
                    yes = res.lower() in ('y', 'yes')
                if yes:
                    subprocess.check_call(cmd)

    if args.verbose:
        print
    
 
